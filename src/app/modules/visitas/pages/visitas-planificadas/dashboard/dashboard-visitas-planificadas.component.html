<h2 nz-typography>Visitas Planificadas</h2>

<nz-divider></nz-divider>

<div
  style="
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    align-items: center;
    margin-bottom: 12px;
  "
>
  <nz-radio-group
    [(ngModel)]="modoFiltroFechas"
    (ngModelChange)="toggleModoFechas()"
    nzButtonStyle="solid"
  >
    <button nz-radio-button [nzValue]="'ciclo'">Filtrar por ciclo</button>
    <button nz-radio-button [nzValue]="'rango'">
      <nz-icon nzType="calendar" /> Filtrar por rango de fechas
    </button>
  </nz-radio-group>

  <nz-divider nzType="vertical"></nz-divider>

  <form [formGroup]="filtrosForm" nz-form nzLayout="inline">
    <nz-form-item *ngIf="modoFiltroFechas === 'ciclo'">
      <nz-form-control>
        <nz-select
          formControlName="ciclo"
          [nzLoading]="ciclosLoading$()"
          [nzOptions]="(cicloOpciones$ | async)!"
          nzPlaceHolder="Seleccione un ciclo"
          style="width: 280px"
        ></nz-select>
      </nz-form-control>
    </nz-form-item>

    <nz-form-item *ngIf="modoFiltroFechas === 'rango'">
      <nz-form-control>
        <nz-range-picker
          formControlName="rangoFechas"
          [nzFormat]="'yyyy-MM-dd'"
          style="width: 280px"
        ></nz-range-picker>
      </nz-form-control>
    </nz-form-item>
  </form>

  <button
    nz-button
    nzType="primary"
    [disabled]="filtrosForm.invalid"
    (click)="buscar()"
    [nzLoading]="isLoading"
  >
    <nz-icon nzType="search" />
    Buscar
  </button>
  <nz-divider nzType="vertical"></nz-divider>
  <button (click)="open()" nz-button nzType="default">
    <nz-icon nzType="filter" />Filtros
  </button>
  <nz-divider nzType="vertical"></nz-divider>
  <button [nzLoading]="isExporting" nzTrigger="click" nz-button nzType="default" nz-dropdown [nzDropdownMenu]="menu">
    <nz-icon nzType="download" />Exportar
  </button>
  <nz-dropdown-menu #menu="nzDropdownMenu">
      <ul nz-menu>
        <li nz-menu-item>
          <span (click)="exportarResumenExcel()"><nz-icon nzType="global"/><nz-divider nzType="vertical"></nz-divider> Global</span>
        </li>
        <li nz-menu-item>
          <span (click)="descargarExcel()"><nz-icon nzType="monitor"/><nz-divider nzType="vertical"></nz-divider> Detalle</span>
        </li>
      </ul>
    </nz-dropdown-menu>
</div>

<nz-divider></nz-divider>

<nz-drawer
  [nzClosable]="true"
  [nzVisible]="visible"
  [nzPlacement]="'right'"
  nzTitle="Filtros"
  [nzBodyStyle]="{ 'background-color': '#fafafa', padding: '0px' }"
  (nzOnClose)="close()"
>
  <ng-container *nzDrawerContent>
    <app-filtros-visitas-planificadas
      [representantes$]="asesores$"
      [representantesSeleccionados]="representantesSeleccionados"
      [regionesSeleccionadas]="regionesSeleccionadas"
      [seccionesSeleccionadas]="seccionesSeleccionadas"
      [secciones$]="secciones$"
      [fuerzas$]="fuerzas$"
      [fuerzasSeleccionadas]="fuerzasSeleccionadas"
      [(clienteZ)]="filtroClienteZ"
      [(medico)]="filtroMedico"
      [(clienteGenerico)]="filtroClienteGenerico"
      [(observacion)]="observacion"
      [(acompanado)]="acompanado"
      (aplicarFiltros)="onAplicarFiltros($event)"
    >
    </app-filtros-visitas-planificadas>
  </ng-container>
</nz-drawer>

<nz-tabset>
  <nz-tab [nzTitle]="tituloGlobal">
    <ng-template #tituloGlobal>
      <nz-icon nzType="global"/>
      Global
    </ng-template>
    <app-tabla-visitas-agregado
      [data]="dataAgregado"
      [isLoading]="isLoadingAgregado"
      [showClienteZ]="mostrarClienteZ"
      [showMedico]="mostrarMedico"
      [showClienteGenerico]="mostrarClienteGenerico"
    >
    </app-tabla-visitas-agregado
  ></nz-tab>
  <nz-tab [nzTitle]="tituloDetalle">
        <ng-template #tituloDetalle>
      <nz-icon nzType="monitor"/>
      Detalle
    </ng-template>
    <app-tabla-visitas-planificadas
      [data]="data"
      [isLoading]="isLoading"
      [pageIndex]="pageIndex"
      [pageSize]="pageSize"
      [totalItems]="totalItems"
      (pageIndexChange)="onPageIndexChange($event)"
      (pageSizeChange)="onPageSizeChange($event)"
      [showClienteZ]="mostrarClienteZ"
      [showMedico]="mostrarMedico"
      [showClienteGenerico]="mostrarClienteGenerico"
      [showObservacion]="observacion"
      [showAcompanado]="acompanado"
    ></app-tabla-visitas-planificadas>
  </nz-tab>
</nz-tabset>
